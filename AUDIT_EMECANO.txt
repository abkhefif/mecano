AUDIT COMPLET eMecano — Backend + Mobile
=========================================
Date : 25 Fevrier 2026
Tests : 457 passed, 3 skipped, 0 failed


========================================
CRITIQUES (a corriger avant deploy)
========================================

1. [CORRIGE] Telephone non requis avant transaction Stripe
   Backend : bookings/routes.py + proposals/routes.py
   - phone etait optionnel a l'inscription ET a la reservation
   - Fix applique : bloquer booking/proposal si buyer OU mecano n'a pas de telephone

2. [CORRIGE] Prenom/Nom — chaine vide acceptee, pas de validation
   Backend : schemas/auth.py
   - first_name et last_name acceptaient chaines vides, chiffres, symboles
   - Fix applique : min 3 chars, regex alphabetique (accents/tirets/apostrophes OK)
   - Validation ajoutee aussi dans UserUpdateRequest

3. [ ] Paiement Stripe saute silencieusement (Expo Go)
   Mobile : BookingConfirmScreen.tsx:225-243
   - Si le module Stripe natif n'est pas dispo, le paiement est skippe mais bookingSuccess = true
   - Le buyer croit avoir paye alors que non
   - Fix : Si initPaymentSheet est null, afficher une erreur et NE PAS confirmer la reservation

4. [CORRIGE] Type vehicule hardcode dans les propositions
   Mobile : MechanicDetailScreen.tsx
   - Le modal de proposition forcait VehicleType.CAR — moto et utilitaire impossibles
   - Fix applique : selecteur 3 boutons (Voiture/Moto/Utilitaire) avec icones

5. [CORRIGE] Verification email ne verifie rien
   Backend : auth/routes.py + email_service.py + schemas/auth.py + user.py
   Mobile : EmailVerificationScreen.tsx + authStore.ts + api.ts
   - Fix : Code OTP 6 chiffres envoye par email, saisi dans l'app, verifie via POST /auth/verify-email

6. [CORRIGE] Profil buyer — aucune validation avant sauvegarde
   Mobile : ProfileScreen.tsx
   - handleSave envoyait directement sans verifier — prenom vide, email invalide, tout passait
   - Fix applique : validation prenom/nom (3 chars, alphabetique), email (@), telephone (10-15 chiffres)

7. [CORRIGE] accept_proposal sans limite 6 jours Stripe
   Backend : proposals/routes.py
   - Pas de verification STRIPE_AUTH_MAX_ADVANCE_DAYS — une proposition pour dans 30 jours
     creerait un hold Stripe qui expire apres 7 jours
   - Fix applique : meme validation que dans create_booking + verification email + telephone

8. [CORRIGE] Session ORM partagee dans release_overdue_payments
   Backend : scheduler.py
   - Un rollback() apres un echec Stripe corrompait la session pour les bookings suivants
   - Fix applique : architecture 2 phases avec session isolee par booking


========================================
IMPORTANTS (a corriger pour la qualite)
========================================

--- Backend ---

 9. [CORRIGE] JWT retourne a l'inscription avant verification email — acces complet sans verifier
      Fichier : auth/routes.py
      Fix : inscription retourne uniquement {"message": "..."}, plus de JWT

10. [CORRIGE] vehicle_plate sans regex — injection possible dans le PDF
      Fichier : schemas/booking.py
      Fix : pattern regex ^[A-Za-z0-9\- ]+$ sur vehicle_plate

11. [CORRIGE] accept_proposal n'utilise pas get_verified_buyer pour le buyer
      Fichier : proposals/routes.py
      Fix : verification email + telephone pour buyer ET mecano dans accept_proposal

12. [CORRIGE] Admin ne peut pas desactiver un buyer abusif (pas d'endpoint)
      Fichier : admin/routes.py + dependencies.py + user.py
      Fix : champ is_active sur User, endpoint PATCH /admin/users/{id}/deactivate, blocage auth

13. [CORRIGE] TRUSTED_PROXY_COUNT=0 — rate limiting inefficace sur Render
      Fichier : config.py
      Fix : default change de 0 a 1 (Render reverse proxy)

14. [CORRIGE] release_overdue_payments utilise updated_at au lieu de validated_at
      Fichier : scheduler.py
      Fix : commentaire explicatif — updated_at sert de proxy pour validated_at (pas de champ dedie)

15. [CORRIGE] cancel_booking 0% ne met pas payment_released_at
      Fichier : bookings/routes.py
      Fix : payment_released_at = now() apres capture du paiement a 0% de remboursement

16. [CORRIGE] GPS mecano exact expose dans le detail (precision au metre)
      Fichier : bookings/routes.py (get_location)
      Fix : arrondi a 3 decimales (~111m de precision)

17. [CORRIGE] RESEND_API_KEY non requise en production — emails silencieusement desactives
      Fichier : config.py
      Fix : ValueError dans validate_production_settings si RESEND_API_KEY absent

--- Mobile ---

18. [ ] Pas de confirmation de mot de passe a l'inscription
      Fichier : RegisterScreen.tsx

19. [ ] Pas de bouton retour sur BookingConfirmScreen — user coince
      Fichier : BookingConfirmScreen.tsx

20. [ ] Politique annulation inconsistante entre 2 ecrans (2h vs 12h)
      Fichier : BookingDetailScreen.tsx:48 vs BookingConfirmScreen.tsx

21. [ ] Checkout possible sans aucune photo
      Fichier : CheckOutScreen.tsx

22. [ ] Pas de confirmation avant soumission checkout
      Fichier : CheckOutScreen.tsx

23. [ ] AvailabilityScreen muet si profil mecano incomplet
      Fichier : AvailabilityScreen.tsx

24. [ ] Messagerie sans auto-refresh (pas de polling)
      Fichier : BookingMessagesScreen.tsx

25. [ ] Bouton "Garantie" expose un placeholder "bientot disponible"
      Fichier : BookingDetailScreen.tsx

26. [ ] Pas de photo de profil pour le buyer
      Fichier : ProfileScreen.tsx

27. [ ] Pas de gestion des moyens de paiement sauvegardes
      Fichier : ProfileScreen.tsx

28. [ ] Revenue mecano bucketisee par created_at au lieu de slot_date
      Fichier : DashboardScreen.tsx

29. [ ] city mecano sans geocodification — coordonnees potentiellement invalides
      Fichier : MechanicProfileScreen.tsx

30. [ ] Resend email sans cooldown — spam possible
      Fichier : EmailVerificationScreen.tsx

31. [ ] CheckIn code — pas de bouton "copier"
      Fichier : CheckInScreen.tsx

32. [ ] navigation.replace("BookingDetail") apres accept proposal — peut casser selon le role
      Fichier : ProposalDetailScreen.tsx


========================================
MINEURS
========================================

33. [ ] vehicle_year utilise datetime.now() sans timezone
      Fichier : schemas/booking.py:35

34. [ ] Dispos non alignees sur 30 min (9:07 accepte)
      Fichier : schemas/mechanic.py:95

35. [ ] Suspension admin hardcodee a 30 jours
      Fichier : admin/routes.py:264

36. [ ] /metrics sans rate limiting
      Fichier : main.py:254

37. [ ] 2 cards identiques sur HomeScreen buyer
      Fichier : HomeScreen.tsx:46

38. [ ] Chip rayon sur SearchScreen non-cliquable
      Fichier : SearchScreen.tsx:282

39. [ ] Couleurs hardcodees dans EmailVerificationScreen
      Fichier : EmailVerificationScreen.tsx

40. [ ] Polices hardcodees dans MechanicHomeScreen
      Fichier : MechanicHomeScreen.tsx

41. [ ] Proposition date sans gestion timezone
      Fichier : MyBookingsScreen.tsx:252

42. [ ] Description litige sans longueur minimale
      Fichier : ValidationScreen.tsx

43. [ ] Pas de "reset filtres" sur SearchScreen
      Fichier : SearchScreen.tsx


========================================
RESUME
========================================

CRITIQUES :  7/8 corriges  (reste 3)
IMPORTANTS : 9/24 corriges (reste 18-32)
MINEURS :    0/11 corriges

Total : 16/43 corriges
