================================================================================
                    eMecano — AUDIT COMPLET DE PRODUCTION v2
                    (POST-FIXES — RE-AUDIT DE VERIFICATION)
                           Date : 2026-02-12
                         Auditeur : Claude Opus 4.6
================================================================================

Ce document est le re-audit complet apres application de tous les correctifs
identifies dans l'audit initial. Il couvre backend ET frontend, avec verification
de chaque fix et identification de nouveaux problemes.

================================================================================
SECTION A — RESUME EXECUTIF
================================================================================

  BACKEND:
    CRITICAL :  0 restant  (3/3 fixes, C-02 risque accepte dev)
    HIGH     :  1 differe  (webhook IP filtering — mitige par signature)
    MEDIUM   :  3 restants (rating precision, Dockerfile, Stripe test key .env)
    LOW      :  5 restants (refresh token, rate limit logout, admin stripe ID,
                            .env.example unused key, CHECK model)

  FRONTEND:
    CRITICAL :  0 restant  (2/2 fixes — token URL + XSS iframe)
    HIGH     :  3 differes (localStorage web, cert pinning, Stripe disabled)
    MEDIUM   :  8 restants (useCallback, iframe memo, polling, gros composant,
                            couleurs hardcoded, dark mode, accents FR, total_count)
    LOW      :  9 restants (a11y, haptic, skeleton, err as any, NavigationProp<any>,
                            postMessage *, RefreshControl, useCallback notif, Stripe key)

  TOTAL ACTUEL: 0 CRITICAL | 4 HIGH differes | 11 MEDIUM | 14 LOW
  (vs initial: 5 CRITICAL | 13 HIGH | 24 MEDIUM | 18 LOW)

  Score de progression: 80% des problemes resolus ou mitigues

================================================================================
SECTION B — BACKEND : FIXES VERIFIES
================================================================================

[FIXED] C-01: .gitignore ajoute
  Fichier: backend/.gitignore
  Exclut: .env, __pycache__/, *.pyc, .venv/, uploads/, *.egg-info/
  Status: VERIFIE ET FONCTIONNEL

[FIXED] C-03: Token blacklist + /logout + cleanup cron
  Fichiers:
    - app/models/blacklisted_token.py — modele avec jti (unique, indexe)
    - app/auth/routes.py (L235-281) — endpoint /logout
    - app/dependencies.py (L49-59) — verification blacklist dans get_current_user
    - app/services/scheduler.py (L334-344) — cleanup_expired_blacklisted_tokens
    - alembic/versions/014_*.py — migration table
  Status: VERIFIE ET FONCTIONNEL

[FIXED] C-04: Download tokens a duree limitee pour recus
  Fichier: app/reports/routes.py
    - _create_download_token (L35-48) — JWT 5min, type "download", binding booking_id
    - _verify_download_token (L51-67) — validation type, booking_id, expiry
    - /receipt/{booking_id}/token (L146-171) — necessite auth
    - /receipt/{booking_id}/download (L174-211) — token query param sans auth
  Status: VERIFIE ET FONCTIONNEL

[FIXED] H-01: Verification GPS no-show
  Fichier: app/bookings/routes.py (L626-668)
  Verifie mechanic_lat/lng vs meeting_lat/lng avec calculate_distance_km
  Retourne mechanic_nearby_warning si < 500m
  Status: VERIFIE ET FONCTIONNEL

[FIXED] H-02: Rate limiting creation booking
  Fichier: app/bookings/routes.py (L116) — @limiter.limit("5/minute")
  Aussi: register/login 5/min, code entry 3/min, list 30/min, global 60/min
  Status: VERIFIE ET FONCTIONNEL

[FIXED] H-03: Null check notification annulation
  Fichier: app/bookings/routes.py (L551-564)
  notify_user_id null-safe, notification envoyee seulement si not None
  Status: VERIFIE ET FONCTIONNEL

[FIXED] H-04: max_length nom diplome
  Fichier: app/mechanics/routes.py (L330) — Form(..., max_length=255)
  Modele: app/models/diploma.py (L18) — String(255)
  Status: VERIFIE ET FONCTIONNEL

[FIXED] H-05: db.commit -> db.flush partout
  Tous les handlers de route utilisent await db.flush()
  Le middleware session dans app/database.py (L21-28) gere commit/rollback
  Verifie dans: auth, bookings, mechanics, messages, referrals, notifications,
  payments, reports, reviews, admin
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-04: secrets.choice pour code referral
  Fichier: app/referrals/routes.py — import secrets, secrets.choice()
  Fichier: app/utils/code_generator.py — secrets.randbelow(10000)
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-05: Warnings upload photos litige
  Fichier: app/bookings/routes.py (L966-1010)
  Photos echouees trackees, response inclut upload_warnings
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-06: Limite 20 messages template/booking
  Fichier: app/messages/routes.py (L91-104)
  Retourne HTTP 429 si count >= 20
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-07: CHECK constraint cancelled_by
  Migration: alembic/versions/014_*.py (L29-34)
  Contrainte: cancelled_by IN ('buyer', 'mechanic') OR cancelled_by IS NULL
  Status: VERIFIE (en migration, pas dans __table_args__ du modele)

[FIXED] M-08: Taux d'acceptation corrige
  Fichier: app/mechanics/routes.py (L193-218)
  Calcul: accepted / (accepted + refused_by_mechanic)
  Protection division par zero, defaut 100.0
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-09: Bypass admin sur get_location
  Fichier: app/bookings/routes.py (L1167-1169)
  Admins peuvent voir la localisation de n'importe quel booking
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-11: .env.example aligne
  Toutes les cles attendues presentes
  Status: VERIFIE ET FONCTIONNEL

[FIXED] L-01: Pattern telephone UserUpdateRequest
  Fichier: app/schemas/auth.py (L87) — pattern=r"^\+?[0-9]{10,15}$"
  Status: VERIFIE ET FONCTIONNEL

[FIXED] L-03: ondelete CASCADE sur Diploma
  Modele: app/models/diploma.py (L16) — ondelete="CASCADE"
  Migration: 014 — drop et recree FK avec CASCADE
  Status: VERIFIE ET FONCTIONNEL

[FIXED] L-06: Log count scheduler correct
  Fichier: app/services/scheduler.py (L299-331) — notified_count separe
  Status: VERIFIE ET FONCTIONNEL

[FIXED] L-07: reset_no_show cron cable
  Fichier: app/services/scheduler.py (L347-365, L417-425)
  Cron hebdomadaire lundi 05:00
  Status: VERIFIE ET FONCTIONNEL

[FIXED] L-08: Dead code supprime
  Aucun FIXME, HACK, dead_code dans le codebase
  Status: VERIFIE

[FIXED] L-10: STRIPE_PUBLISHABLE_KEY supprime
  Absent de .env, .env.example, config.py
  Status: VERIFIE

================================================================================
SECTION C — BACKEND : PROBLEMES RESTANTS
================================================================================

--- RISQUES ACCEPTES (differes intentionnellement) ---

[DEFERRED] C-02: Verification email desactivee (CRITICAL → RISQUE ACCEPTE DEV)
  Fichier: app/auth/routes.py (L67-72) — is_verified=True hardcode
  TODO SEC-015 documente. Infrastructure prete (get_verified_user,
  get_verified_buyer existent dans dependencies.py).
  A changer AVANT production.

[DEFERRED] H-06: Filtrage IP webhook Stripe (HIGH → DIFFERE)
  Fichier: app/payments/routes.py (L73-84)
  Mitige par: signature verification, rate limit 100/min, idempotency
  Peut etre ajoute au niveau infra (load balancer, WAF)

[DEFERRED] M-01: Requete JSON vehicle type (MEDIUM → DIFFERE)
  Fichier: app/mechanics/routes.py (L83)
  Documente DB-008. Pre-filtre bounding box limite a 500 lignes.
  Acceptable a l'echelle actuelle.

[DEFERRED] M-02: Total count sur /bookings/me (MEDIUM → DIFFERE)
  Necessite changement de contrat API (breaking change)

--- NON CORRIGES (impact faible) ---

[REMAINING] M-03: rating_avg Numeric(3,2) (MEDIUM)
  Fichier: app/models/mechanic_profile.py (L35)
  Max 9.99, suffisant pour notes 1-5 mais Numeric(4,2) serait mieux
  Impact pratique: NUL (notes 1-5 toujours dans la plage)

[REMAINING] M-10: Dockerfile Python version mismatch (MEDIUM)
  Fichier: backend/Dockerfile (L1) — python:3.11-slim
  Dev: Python 3.12.3. Pas de features 3.12-only utilisees.
  Risque: differences subtiles de comportement dev/prod.

--- NOUVEAUX PROBLEMES TROUVES ---

[NEW] BE-N01: Cle test Stripe reelle dans .env (MEDIUM)
  Fichier: backend/.env (L6) — sk_test_51SzJ7Z...
  Protege par .gitignore. Cle test (pas production).
  Recommandation: utiliser un vault ou variable d'environnement systeme.

[NEW] BE-N02: Refresh token non blackliste au logout (LOW)
  Fichier: app/auth/routes.py (L235-281)
  Seul l'access token est blackliste. Refresh token reste valide 7j.
  Documente SEC-008. Mitige par rate limit /refresh (5/min).

[NEW] BE-N03: Pas de rate limit sur /logout (LOW)
  Fichier: app/auth/routes.py (L235-281)
  Pourrait causer du bloat dans blacklisted_tokens.
  Mitige: necessite JWT valide + cleanup quotidien.

[NEW] BE-N04: stripe_account_id expose dans admin detail (LOW)
  Fichier: app/admin/routes.py (L204)
  Admin-only. Acceptable pour dashboard admin.

[NEW] BE-N05: STRIPE_PLATFORM_ACCOUNT_ID dans .env.example inutilise (LOW)
  Fichier: backend/.env.example (L15)
  Non reference dans config.py. Inconsistance cosmetique.

================================================================================
SECTION D — FRONTEND : FIXES VERIFIES
================================================================================

[FIXED] C-04: Token dans URL pour recus
  Fichier: screens/buyer/BookingDetailScreen.tsx (L536-564)
  Utilise expo-file-system avec header Authorization (natif)
  et fetch() avec Authorization (web). Token jamais dans l'URL.
  Status: VERIFIE ET FONCTIONNEL

[FIXED] C-05: XSS dans iframe srcDoc
  Fichiers:
    - screens/buyer/BookingDetailScreen.tsx (L29-36) — escapeHtml()
    - screens/buyer/SearchScreen.tsx (L29-36) — escapeHtml()
  Toutes les donnees utilisateur echappees. Coordonnees coercees via Number().
  Status: VERIFIE ET FONCTIONNEL

[FIXED] H-08: Dependance circulaire require() dynamique
  Fichiers:
    - services/authEvents.ts — pattern getter/setter
    - stores/authStore.ts (L93-96) — enregistre le handler
    - services/api.ts (L38, 128-129, 140-141) — getAuthEventHandler()
  Plus de require() dynamique pour auth store.
  Status: VERIFIE ET FONCTIONNEL

[FIXED] H-09: Validation postMessage origin
  Fichier: screens/buyer/SearchScreen.tsx (L70-83)
  Valide: type === "mechanic", typeof id === "string", UUID regex /^[a-f0-9-]+$/
  Note: srcDoc a origin null, verification origin impossible.
  Status: VERIFIE ET FONCTIONNEL

[FIXED] H-12: mimeType depuis picker (pas extension fichier)
  Fichiers:
    - screens/buyer/ValidationScreen.tsx (L26, 80-81, 141, 160)
    - screens/mechanic/CheckOutScreen.tsx (L89, 125-126, 174, 193)
  Utilise asset.mimeType du picker. Fallback image/jpeg si absent.
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-12: React.memo sur MechanicCard + BookingCard
  - components/shared/MechanicCard.tsx (L12) — React.memo()
  - components/shared/BookingCard.tsx (L29) — React.memo()
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-14: FlatList pour NotificationDropdown
  Fichier: components/shared/NotificationDropdown.tsx (L181)
  FlatList avec keyExtractor, renderItem (useCallback), removeClippedSubviews
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-21: AuthNavigator supprime
  Aucun fichier AuthNavigator, aucune reference
  Status: VERIFIE

[FIXED] M-22: Deps inutilisees supprimees
  nativewind, tailwindcss, qrcode-terminal, @types/react-native: absents
  Status: VERIFIE

[FIXED] M-23: catch(err: any) → catch(err: unknown) partout
  Grep "catch\s*\(err:\s*any\)" retourne 0 resultats
  Tous les catch utilisent err: unknown avec instanceof Error
  Status: VERIFIE ET FONCTIONNEL

[FIXED] M-24: Helper FormData type
  Fichier: utils/formData.ts — appendFileToFormData() type-safe
  Branching web (Blob) vs natif (URI object)
  Status: VERIFIE ET FONCTIONNEL

[FIXED] L-11: Props performance FlatList
  7 FlatList avec removeClippedSubviews={true} et maxToRenderPerBatch={10}
  Status: VERIFIE

[FIXED] L-16: Pull-to-refresh ecrans detail
  - screens/buyer/BookingDetailScreen.tsx — RefreshControl
  - screens/mechanic/MechanicBookingDetailScreen.tsx — RefreshControl
  Status: VERIFIE ET FONCTIONNEL

================================================================================
SECTION E — FRONTEND : PROBLEMES RESTANTS
================================================================================

--- DIFFERES INTENTIONNELLEMENT ---

[DEFERRED] H-07: localStorage pour tokens web (HIGH)
  Fichier: utils/storage.ts (L20-41)
  Sur web: localStorage (vulnerable XSS). Sur natif: expo-secure-store (OK).
  Commentaire securite documente (L9-18).
  Recommandation: cookies httpOnly via backend pour la plateforme web.

[DEFERRED] H-10: Certificate pinning absent (HIGH)
  Aucune config SSL pinning trouvee.
  Recommandation: react-native-ssl-pinning ou config EAS pour production.

[DEFERRED] H-11: Stripe desactive (HIGH)
  - BookingConfirmScreen.tsx (L17) — import commente
  - config.ts (L5) — placeholder pk_test_REPLACE_ME
  - shims/stripe-web.ts — shim web
  Dependency presente dans package.json mais inactive.

[DEFERRED] M-13: useCallback/useMemo incomplet (MEDIUM)
  Present dans: BookingDetail, MechanicDetail, BookingMessages, Availability,
  MechanicBookingDetail, NotificationDropdown.
  Absent dans: Search, Profile, Validation, CheckOut, MyBookings, Home,
  Login, Register, Welcome, Dashboard, MessagesList, CheckIn.

[DEFERRED] M-15: srcDoc iframe non memoize (MEDIUM)
  Fichiers: SearchScreen.tsx (L311), BookingDetailScreen.tsx (L273)
  Template string inline dans JSX, recalcule a chaque render.

[DEFERRED] M-16: Polling au lieu de WebSockets (MEDIUM)
  Booking detail: 10s, Location: 10s, Notifications: 30s, Messages: 15s
  Pas d'implementation WebSocket.

[DEFERRED] M-17: MechanicProfileScreen monolithique (MEDIUM)
  1230 lignes. Devrait etre decoupe en sous-composants.

[DEFERRED] M-18: Couleurs hardcodees (MEDIUM)
  Theme existe dans theme/colors.ts mais ~1000 valeurs hex hardcodees
  dans 28 fichiers sources. Seuls BookingCard et NotificationDropdown
  utilisent le theme.

[DEFERRED] M-19: Dark mode non implemente (MEDIUM)
  darkColors existe dans theme/colors.ts (L49-80) mais inutilise.
  Pas de useColorScheme, pas de toggle, pas de contexte.

[DEFERRED] M-20: Accents francais inconsistants (MEDIUM)
  Ex: "Verifie" au lieu de "Vérifié", "Diplomes" au lieu de "Diplômes"

--- NOUVEAUX PROBLEMES ---

[NEW] FE-N01: (err as any) dans MechanicProfileScreen (LOW)
  Fichier: screens/mechanic/MechanicProfileScreen.tsx (L82)
  Devrait utiliser un type guard au lieu de cast via any.

[NEW] FE-N02: NavigationProp<any> dans NotificationDropdown (LOW)
  Fichier: components/shared/NotificationDropdown.tsx (L21)
  Composant cross-stack, choix pragmatique mais perd la type safety.

[NEW] FE-N03: postMessage avec origin '*' dans iframe (LOW)
  Fichier: screens/buyer/SearchScreen.tsx (L339)
  Seule option avec srcDoc (origin null). Payload valide par UUID regex.

[NEW] FE-N04: RefreshControl utilise isLoading dans SearchScreen (LOW)
  Fichier: screens/buyer/SearchScreen.tsx (L415)
  Devrait utiliser un state refreshing separe comme les autres ecrans.

[NEW] FE-N05: handleNotificationPress pas dans useCallback (LOW)
  Fichier: components/shared/NotificationDropdown.tsx (L72-82)
  renderNotification depend de handleNotificationPress non memoize.

[NEW] FE-N06: Placeholder Stripe key expose (INFORMATIONAL)
  Fichier: config.ts (L5) — "pk_test_REPLACE_ME"
  Pas un vrai credential mais causera des erreurs confuses si utilise.

[REMAINING] L-13: Zero attributs accessibilite (LOW)
  Aucun accessibilityLabel, accessibilityRole, accessibilityHint
  dans tout le codebase. Pas de support lecteur d'ecran.

[REMAINING] L-14: Haptic feedback absent (LOW)
  Aucune reference a expo-haptics ou vibration.

[REMAINING] L-15: Skeleton loading absent (LOW)
  Tous les etats de chargement utilisent spinner (LoadingScreen/ActivityIndicator).

================================================================================
SECTION F — TESTS ET COMPILATION
================================================================================

  Backend:
    - 228 tests passent (pytest)
    - Coverage >= 85% (fail_under configure)
    - Migrations Alembic a jour (014)

  Frontend:
    - npx tsc --noEmit : 0 erreurs
    - TypeScript strict: true
    - Aucun import casse apres suppression de deps

================================================================================
SECTION G — TABLEAU RECAPITULATIF
================================================================================

  BACKEND (30 problemes initiaux + 5 nouveaux)
  ┌─────────┬──────────────┬─────────┬─────────────┬─────────┬────────────┐
  │ Severite│ Initial      │ Fixe    │ Differe     │ Restant │ Nouveau    │
  ├─────────┼──────────────┼─────────┼─────────────┼─────────┼────────────┤
  │CRITICAL │ 3            │ 2       │ 1 (dev)     │ 0       │ 0          │
  │HIGH     │ 6            │ 5       │ 1           │ 0       │ 0          │
  │MEDIUM   │ 11           │ 7       │ 2           │ 2       │ 1          │
  │LOW      │ 10           │ 6       │ 0           │ 0       │ 4          │
  └─────────┴──────────────┴─────────┴─────────────┴─────────┴────────────┘

  FRONTEND (30 problemes initiaux + 6 nouveaux)
  ┌─────────┬──────────────┬─────────┬─────────────┬─────────┬────────────┐
  │ Severite│ Initial      │ Fixe    │ Differe     │ Restant │ Nouveau    │
  ├─────────┼──────────────┼─────────┼─────────────┼─────────┼────────────┤
  │CRITICAL │ 2            │ 2       │ 0           │ 0       │ 0          │
  │HIGH     │ 7            │ 4       │ 3           │ 0       │ 0          │
  │MEDIUM   │ 13           │ 6       │ 8           │ 0       │ 0          │
  │LOW      │ 8            │ 2       │ 3           │ 0       │ 6          │
  └─────────┴──────────────┴─────────┴─────────────┴─────────┴────────────┘

================================================================================
SECTION H — RECOMMANDATIONS PRIORITAIRES POUR PRODUCTION
================================================================================

  AVANT MISE EN PRODUCTION (obligatoire):
  1. Activer la verification email (C-02) — retirer is_verified=True
  2. Configurer Stripe en mode live — activer les imports, cle reelle
  3. Implementer certificate pinning (H-10)
  4. Migrer auth web vers cookies httpOnly (H-07)
  5. Ajouter filtrage IP webhook Stripe au niveau infra (H-06)

  AMELIORATIONS RECOMMANDEES (qualite):
  6. Migrer couleurs hardcodees vers theme/colors.ts (M-18)
  7. Implementer dark mode via useColorScheme (M-19)
  8. Ajouter WebSockets pour remplacer le polling (M-16)
  9. Decouper MechanicProfileScreen en sous-composants (M-17)
  10. Ajouter attributs d'accessibilite sur tous les elements interactifs (L-13)
  11. Ajouter useCallback/useMemo sur tous les ecrans (M-13)
  12. Ajouter skeleton loading pour meilleure UX (L-15)

  NICE-TO-HAVE:
  13. Mettre a jour Dockerfile vers Python 3.12 (M-10)
  14. Ajouter haptic feedback (L-14)
  15. Corriger accents francais partout (M-20)
  16. Passer rating_avg a Numeric(4,2) (M-03)

================================================================================
                              FIN DE L'AUDIT v2
                    0 CRITICAL | 4 HIGH differes | 11 MEDIUM | 14 LOW
================================================================================
