================================================================================
                        eMecano - COMPREHENSIVE TODO LIST
                        Full Project Audit (Backend + Frontend)
                        Generated: 2026-02-10
================================================================================

Legend:
  [CRITICAL]  - Must fix before any deployment / data integrity risk
  [HIGH]      - Must fix before production / security risk
  [MEDIUM]    - Should fix soon / quality & reliability concern
  [LOW]       - Nice to have / minor improvement

================================================================================
                         SECTION 1: CRITICAL BUGS
================================================================================

1. [CRITICAL] Reviews DB constraint blocks dual reviews
   Backend: alembic/versions/001_initial.py line 185
   Backend: app/models/review.py line 14
   The migration has unique=True on booking_id column alone, but the model
   intends a composite UniqueConstraint(booking_id, reviewer_id). Only one
   review per booking is possible at DB level. The second reviewer gets 500.
   FIX: Create a new migration removing the column-level unique on booking_id
   and ensuring the composite constraint exists.

2. [CRITICAL] CheckOutScreen sends wrong enum values to backend
   Frontend: src/screens/mechanic/CheckOutScreen.tsx lines 22-29
   Local types use capitalized values ("OK", "Warning", "Buy", "Normal")
   but backend expects lowercase enums ("ok", "warning", "buy", "normal").
   Also: DriveBehavior uses "Unusual"/"Concerning" locally vs "suspect"/
   "dangerous" on backend. The entire checkout flow is broken.
   FIX: Import and use the shared enums from types/index.ts instead of
   re-declaring local type aliases.

3. [CRITICAL] Default JWT secret allows token forgery
   Backend: app/config.py line 15
   JWT_SECRET defaults to "change-this-in-production". APP_ENV defaults to
   "development". If both are missing from .env, app runs with predictable
   secret.
   FIX: Remove the default value or require JWT_SECRET as a mandatory env var.

4. [CRITICAL] Migration/Model column mismatches
   Multiple columns in the ORM models are missing from the initial migration:
   - bookings.check_in_code_attempts (model line 44)
   - users.first_name, users.last_name (model lines 19-20)
   - mechanic_profiles.accepted_vehicle_types uses JSON in model but
     ARRAY(String) in migration
   FIX: Create a new Alembic migration to add missing columns and fix types.

================================================================================
                         SECTION 2: SECURITY FIXES
================================================================================

5. [HIGH] Token stored in AsyncStorage (unencrypted)
   Frontend: src/stores/authStore.ts lines 30, 38, 50
   JWT stored in plaintext AsyncStorage. Readable on rooted devices.
   FIX: Migrate to expo-secure-store (uses Keychain/Android Keystore).

6. [HIGH] API uses plaintext HTTP
   Frontend: src/services/api.ts line 29
   API_BASE_URL is hardcoded to http://10.0.2.2:8000. No env-based switching.
   Stripe client_secret transmitted unencrypted.
   FIX: Add environment-based config (dev/staging/prod) with HTTPS for
   non-development environments.

7. [HIGH] 401 interceptor doesn't trigger full logout
   Frontend: src/services/api.ts lines 52-54
   Only removes AsyncStorage token but doesn't update Zustand store.
   User stays in authenticated UI with all API calls failing.
   FIX: Call useAuthStore.getState().logout() in the 401 handler.

8. [HIGH] Email verification never enforced
   Backend: app/dependencies.py lines 51-60 (get_verified_user exists but unused)
   Backend: app/auth/routes.py line 56 (TODO: Send verification email)
   Unverified users have full platform access.
   FIX: Use get_verified_user dependency on booking/payment endpoints.
   Implement email verification flow.

9. [HIGH] Rate limits defined but never applied
   Backend: app/utils/rate_limit.py lines 7-8
   AUTH_RATE_LIMIT="5/minute" and CODE_ENTRY_RATE_LIMIT="3/minute" defined
   but never used as @limiter.limit() decorators.
   FIX: Add @limiter.limit(AUTH_RATE_LIMIT) to login/register endpoints,
   @limiter.limit(CODE_ENTRY_RATE_LIMIT) to enter-code endpoint.

10. [HIGH] No token revocation / blacklisting
    Backend: app/dependencies.py lines 21-48
    No way to invalidate tokens after password change, suspension, or logout.
    Suspended mechanics can keep using tokens for 24 hours.
    FIX: Implement Redis-based token blacklist. Add jti claim to JWT.

11. [HIGH] No account lockout after failed logins
    Backend: app/auth/routes.py lines 63-77
    Global rate limit is 60/min, but per-endpoint auth limit is never applied.
    FIX: Apply AUTH_RATE_LIMIT and implement progressive lockout.

12. [HIGH] CheckOutRequest schema never used for validation
    Backend: app/bookings/routes.py lines 348-359
    Backend: app/schemas/booking.py lines 102-107
    The check_out endpoint accepts raw form params with minimal manual
    validation instead of using the properly-validated CheckOutRequest schema.
    FIX: Either use the schema or replicate all its validation rules.

13. [HIGH] Dockerfile uses --reload in production CMD
    Backend: Dockerfile line 21
    FIX: Remove --reload flag. Use separate docker-compose for development.

14. [HIGH] Query cache not cleared on logout
    Frontend: src/stores/authStore.ts lines 43-45
    Stale data from previous user visible to next login.
    FIX: Call queryClient.clear() in logout flow.

15. [MEDIUM] Add explicit admin registration rejection in route handler
    Backend: app/auth/routes.py line 36
    Currently relies solely on RegistrationRole enum for defense.
    FIX: Add explicit check: if body.role.value == "admin": raise 403

16. [MEDIUM] CORS wildcard methods/headers
    Backend: app/main.py lines 50-56
    allow_methods=["*"] and allow_headers=["*"] overly permissive.
    FIX: Restrict to actual methods (GET, POST, PUT, PATCH, DELETE) and
    required headers (Authorization, Content-Type).

17. [MEDIUM] Missing security headers
    Backend: app/main.py
    No X-Content-Type-Options, X-Frame-Options, HSTS, CSP headers.
    FIX: Add a security headers middleware.

18. [MEDIUM] Hardcoded DB credentials in multiple files
    Backend: app/config.py line 9, docker-compose.yml, alembic.ini
    FIX: Remove defaults from config.py; use .env exclusively.

19. [MEDIUM] Sensitive data logged to console in production
    Frontend: Multiple screens use console.error without __DEV__ guard.
    FIX: Wrap console.error calls in if (__DEV__) checks.

20. [MEDIUM] No Dockerfile non-root user
    Backend: Dockerfile
    Container runs as root.
    FIX: Add USER directive.

21. [MEDIUM] No certificate pinning
    Frontend: src/services/api.ts
    No SSL pinning configured.
    FIX: Consider expo-ssl-pinning or similar for production.

22. [LOW] Stripe publishable key hardcoded
    Frontend: src/config.ts
    FIX: Use expo-constants or app.config.ts for env-based keys.

================================================================================
                         SECTION 3: FEATURE GAPS (TODOs in code)
================================================================================

23. [HIGH] Email verification system
    Backend: app/auth/routes.py line 56 -- "TODO: Send verification email"
    FIX: Implement email sending (SendGrid/SES), verification token,
    /auth/verify-email endpoint.

24. [HIGH] Push notifications
    Backend: Multiple TODO comments:
    - app/bookings/routes.py line 176 "TODO: Notify buyer" (accept)
    - app/bookings/routes.py line 209 "TODO: Notify buyer" (refuse)
    - app/bookings/routes.py line 302 "TODO: Notify admin + mechanic" (no-show)
    - app/bookings/routes.py line 430 "TODO: Notify buyer" (check-out)
    - app/bookings/routes.py line 471 "TODO: Notify admin" (dispute)
    - app/services/scheduler.py line 123 "TODO: Send push notification / SMS"
    FIX: Implement push notification service (Firebase Cloud Messaging).
    Add notification preferences in user profile.

25. [HIGH] Mechanic enter-code UI missing
    Frontend: No screen for mechanic to enter the 4-digit check-in code.
    useEnterCode hook exists but is never used in any screen.
    FIX: Add code entry UI in MechanicBookingDetailScreen for AWAITING_MECHANIC_CODE.

26. [MEDIUM] Admin dashboard
    Backend: Admin role exists but only used for dispute resolution.
    No admin panel for: mechanic identity verification, user management,
    analytics, booking overview, report viewing.
    FIX: Build admin dashboard (web-based).

27. [MEDIUM] Forgot password flow
    Frontend & Backend: No password reset mechanism.
    FIX: Add /auth/forgot-password and /auth/reset-password endpoints.
    Add forgot password screen in mobile app.

28. [MEDIUM] Profile settings screens are non-functional
    Frontend: src/screens/buyer/ProfileScreen.tsx lines 109-132
    Notifications, Privacy, Help, Terms, Privacy Policy buttons do nothing.
    FIX: Implement these screens or add deep links to web pages.

29. [MEDIUM] Review UI for buyer after completion
    Frontend: No screen prompting buyer to leave a review after booking
    completes. The useCreateReview hook exists but is unused.
    FIX: Add review prompt in booking detail when status is COMPLETED.

30. [LOW] Mechanic identity verification admin flow
    Backend: Identity documents are uploaded but is_identity_verified
    is set to False awaiting admin review. No admin endpoint to approve.
    FIX: Add /admin/mechanics/{id}/verify endpoint.

================================================================================
                         SECTION 4: BUG FIXES
================================================================================

31. [HIGH] Race condition in auth state during login
    Frontend: src/stores/authStore.ts lines 28-33
    isAuthenticated is set true BEFORE fetchUser completes. RootNavigator
    renders authenticated stack with user=null, causing potential crash
    on user.role check.
    FIX: Set isAuthenticated only after fetchUser succeeds.

32. [HIGH] Booking detail fetched via full list scan
    Frontend: src/hooks/useBookings.ts lines 26-36
    useBookingDetail fetches entire booking list to find one booking.
    FIX: Add GET /bookings/{id} endpoint on backend. Use it in the hook.

33. [HIGH] No idempotency protection on booking creation
    Backend: app/bookings/routes.py lines 48-153
    Network retries could create multiple Stripe PaymentIntents.
    FIX: Add idempotency key support (header-based or request body field).

34. [MEDIUM] Mock prices displayed in BookingConfirmScreen
    Frontend: src/screens/buyer/BookingConfirmScreen.tsx lines 199-202
    Hardcoded EUR 55.00 shown but actual price may differ.
    FIX: Add a /bookings/price-estimate endpoint or display prices from
    the mechanic detail response.

35. [MEDIUM] Availability form has no date/time validation
    Frontend: src/screens/mechanic/AvailabilityScreen.tsx lines 54-58
    Free-form text inputs for date and time with no format validation.
    FIX: Use date/time pickers (expo-date-time-picker) instead of TextInput.

36. [MEDIUM] Vehicle types input is free-text in mechanic profile
    Frontend: src/screens/mechanic/MechanicProfileScreen.tsx lines 44-48
    Comma-separated text input instead of multi-select checkboxes.
    FIX: Use VehicleType enum chips/checkboxes for selection.

37. [MEDIUM] No date validation on availability creation (backend)
    Backend: app/schemas/mechanic.py lines 67-70
    Mechanics can create slots for past dates.
    FIX: Add validator to ensure date >= today.

38. [MEDIUM] Dispute resolution endpoint uses raw string params
    Backend: app/payments/routes.py lines 112-118
    dispute_id as string with no UUID validation. resolution as raw string.
    FIX: Use Pydantic schema for request body. Use uuid.UUID for path param.

39. [MEDIUM] No cancellation fee for confirmed bookings
    Backend: app/bookings/routes.py lines 214-245
    Buyers can cancel confirmed bookings with full refund.
    FIX: Add time-based cancellation policy (free >24h, partial <24h, etc.)

40. [MEDIUM] formatPrice doesn't handle NaN
    Frontend: src/utils/formatters.ts lines 1-4
    parseFloat("N/A") returns NaN, displayed as "NaN EUR".
    FIX: Add isNaN guard.

41. [MEDIUM] city_lat/city_lng have no bounds in MechanicUpdateRequest
    Backend: app/schemas/mechanic.py lines 11-12
    FIX: Add ge=-90, le=90 for lat, ge=-180, le=180 for lng.

42. [LOW] Check-in code has no time expiry
    Backend: app/bookings/routes.py lines 282-289
    4-digit code remains valid indefinitely.
    FIX: Add code_generated_at timestamp, reject if > 15 minutes old.

43. [LOW] Photo FormData uses hardcoded "image/jpeg" MIME type
    Frontend: src/screens/mechanic/CheckOutScreen.tsx lines 78-83
    FIX: Detect actual MIME type from image picker result.

44. [LOW] Mechanic registered at Null Island (0,0)
    Backend: app/auth/routes.py lines 45-53
    FIX: Require city/coordinates during onboarding flow.

================================================================================
                         SECTION 5: PERFORMANCE
================================================================================

45. [HIGH] N+1 queries on Booking model (7 selectin relationships)
    Backend: app/models/booking.py lines 55-72
    Every booking load triggers 7+ extra queries.
    FIX: Change relationships to lazy="select" (default). Use joinedload()
    or selectinload() explicitly in queries that need related data.

46. [MEDIUM] list_mechanics loads all mechanics into memory
    Backend: app/mechanics/routes.py lines 43-75
    No database-level filtering by distance or pagination.
    FIX: Add PostGIS or haversine formula in SQL. Add pagination.

47. [MEDIUM] Availability list uses ScrollView instead of FlatList
    Frontend: src/screens/mechanic/AvailabilityScreen.tsx
    All items rendered at once with no virtualization.
    FIX: Use FlatList or SectionList.

48. [MEDIUM] Missing database indexes
    Backend: app/models/booking.py, availability.py, review.py
    Missing indexes on: bookings.buyer_id, bookings.mechanic_id,
    bookings.stripe_payment_intent_id, availabilities(mechanic_id, date),
    reviews.reviewee_id
    FIX: Add index=True to these columns and create migration.

49. [LOW] No image compression beyond quality setting
    Frontend: src/screens/mechanic/CheckOutScreen.tsx
    10 photos at 80% quality could be 50+ MB upload.
    FIX: Add resolution constraints or explicit compression.

50. [LOW] No total count in paginated endpoints
    Backend: bookings/me, reviews list
    FIX: Return {items: [...], total: N, limit: N, offset: N}.

================================================================================
                         SECTION 6: CODE QUALITY
================================================================================

51. [MEDIUM] Unused types/dead code
    Frontend: src/types/index.ts - ChecklistInput interface unused
    Frontend: src/theme/colors.ts - entire file unused (never imported)
    FIX: Remove dead code.

52. [MEDIUM] useMechanicDashboard is mutation instead of query
    Frontend: src/hooks/usePayments.ts lines 14-21
    GET request modeled as useMutation (no caching, no deduplication).
    FIX: Change to useQuery with a manual trigger pattern.

53. [MEDIUM] Inconsistent error handling across screens
    Frontend: Mix of err: any, err instanceof Error, err.response?.status
    FIX: Create a shared error handling utility.

54. [MEDIUM] catch (err: any) pervasive across all screens
    Frontend: 10+ screens use catch (err: any)
    FIX: Create typed error handler, use proper error types.

55. [LOW] Deprecated event_loop fixture pattern in tests
    Backend: tests/conftest.py lines 28-32
    FIX: Remove fixture, rely on asyncio_mode = "auto".

56. [LOW] Inconsistent import patterns (barrel vs direct)
    Frontend: Mix of imports from barrel (../../hooks) and direct files.
    FIX: Standardize to barrel imports throughout.

57. [LOW] .gitignore not committed to git
    FIX: git add .gitignore

58. [LOW] No testing infrastructure for frontend
    Frontend: No test runner, no test files, no test scripts.
    FIX: Set up jest + @testing-library/react-native.

59. [LOW] Hardcoded Stripe onboarding URLs
    Backend: app/services/stripe_service.py lines 93-94
    FIX: Move to config settings.

60. [LOW] OpenAPI docs not disabled for production
    Backend: app/main.py
    FIX: Set docs_url=None, redoc_url=None when APP_ENV != "development".

================================================================================
                         SECTION 7: UX IMPROVEMENTS
================================================================================

61. [MEDIUM] No loading state during Stripe payment flow
    Frontend: BookingConfirmScreen.tsx lines 150-174
    FIX: Show spinner while initPaymentSheet runs.

62. [MEDIUM] No confirmation dialog before booking submission
    Frontend: BookingConfirmScreen.tsx
    FIX: Add Alert.alert confirmation before handleConfirmBooking.

63. [MEDIUM] Manual padding instead of SafeAreaView
    Frontend: DashboardScreen, AvailabilityScreen, MechanicProfileScreen
    Use pt-12 instead of SafeAreaView. Breaks on notched devices.
    FIX: Use SafeAreaView or react-native-safe-area-context.

64. [MEDIUM] No pull-to-refresh on SearchScreen
    Frontend: src/screens/buyer/SearchScreen.tsx
    FIX: Add RefreshControl to FlatList.

65. [LOW] No accessibility labels on interactive elements
    Frontend: All screens lack accessibilityLabel/Role/Hint props.
    FIX: Add accessibility props for screen reader support.

66. [LOW] Admin role not handled in navigation
    Frontend: RootNavigator.tsx line 31
    Admin user gets BuyerNavigator by default.
    FIX: Add AdminNavigator or appropriate handling.

67. [LOW] PDF report URL exposed in alert
    Frontend: CheckOutScreen.tsx line 92
    FIX: Show success message without internal URL.

================================================================================
                         SUMMARY
================================================================================

CRITICAL:  4 items  (1-4)
HIGH:     16 items  (5-14, 23-25, 31-33, 45)
MEDIUM:   30 items  (15-22, 26-29, 34-41, 46-48, 51-54, 61-64)
LOW:      19 items  (30, 42-44, 49-50, 55-60, 65-67)

TOTAL:    69 items

Priority order for production readiness:
  1. Fix CRITICAL bugs (items 1-4)
  2. Address security fixes (items 5-14)
  3. Implement missing features (items 23-25)
  4. Fix application bugs (items 31-33)
  5. Performance optimizations (items 45-48)
  6. Everything else

================================================================================
